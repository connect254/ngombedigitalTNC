<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NGOMBE DIGITAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta
      name="description"
      content="Local marketplace for buying and selling livestock."
    />
    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      #app-wrap {
        min-height: 100vh;
      }
      #list-container a[href*="wa.me"] .rounded-full {
        padding: 8px;
      }
      #list-container a[href*="wa.me"] svg {
        width: 20px;
        height: 20px;
      }
      #list-container a[href*="wa.me"] .text-sm {
        color: #0b6a3a;
        font-weight: 700;
        letter-spacing: 0.02em;
      }
      .whatsapp-reserve {
        background: linear-gradient(90deg, #10b981, #0b6a3a);
        color: white;
      }
      .whatsapp-reserve:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(11, 106, 58, 0.12);
      }
    </style>
  </head>
  <body
    id="app-wrap"
    class="bg-gradient-to-br from-purple-50 to-purple-100 text-gray-900 antialiased"
  >
    <div class="max-w-xl mx-auto p-4">
      <header class="flex items-center justify-between py-2">
        <div class="flex items-center">
          <div
            class="w-14 h-14 rounded-full overflow-hidden bg-white shadow-lg flex items-center justify-center"
          >
            <img
              src="cowsbox/flogo.png"
              alt="Fresian Cow Logo"
              class="object-cover w-full h-full"
            />
          </div>
          <div class="ml-3">
            <h1 class="text-lg font-extrabold">
              NG'OMBE DIGITAL-Tharaka Nithi county
            </h1>
            <p class="text-xs text-gray-600">
              Tharaka Nithi online livestock marketplace
            </p>
          </div>
        </div>
        <a
          href="admin.html"
          class="hidden md:inline-block px-3 py-1 rounded bg-green-700 text-white text-sm"
          >Admin</a
        >
      </header>

      <section
        class="mt-4 glass-card rounded-2xl p-4 shadow-md border border-white/40"
      >
        <h2 class="text-xl font-bold">Buy & Sell Livestock</h2>
        <p class="text-sm text-gray-700 mt-1">
          Reserve/Book an animal and complete payment directly with the seller.
        </p>
        <div class="mt-3 flex gap-2">
          <a
            href="#listings"
            class="flex-1 text-center py-2 rounded-lg bg-gradient-to-r from-green-600 to-green-500 text-white font-semibold"
            >Browse Livestock</a
          >
          <button
            onclick="document.getElementById('how').scrollIntoView({behavior:'smooth'})"
            class="flex-1 py-2 rounded-lg border border-green-700 text-green-700 font-semibold bg-white/60"
          >
            How it works
          </button>
        </div>
      </section>

      <div class="mt-4">
        <input
          id="search"
          placeholder="Search by type, location or title (e.g., cow, Nakuru)"
          class="w-full px-4 py-3 rounded-2xl border border-white/40 shadow-sm focus:outline-none glass-card"
        />
      </div>

      <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
        <div
          class="glass-card p-2 rounded-lg text-center shadow border border-white/30"
        >
          Cows
        </div>
        <div
          class="glass-card p-2 rounded-lg text-center shadow border border-white/30"
        >
          Goats
        </div>
        <div
          class="glass-card p-2 rounded-lg text-center shadow border border-white/30"
        >
          Sheep
        </div>
        <div
          class="glass-card p-2 rounded-lg text-center shadow border border-white/30"
        >
          Poultry
        </div>
        <div
          class="glass-card p-2 rounded-lg text-center shadow border border-white/30"
        >
          Milk & Eggs
        </div>
        <div
          class="glass-card p-2 rounded-lg text-center shadow border border-white/30"
        >
          Manure
        </div>
      </div>

      <section id="listings" class="mt-4">
        <h3 class="text-lg font-semibold">Latest Listings</h3>
        <div id="list-container" class="mt-3 space-y-3"></div>
        <div id="no-results" class="hidden text-center text-gray-600 py-6">
          No listings match your search.
        </div>
      </section>

      <section
        id="how"
        class="mt-6 glass-card rounded-2xl p-4 shadow-md border border-white/40"
      >
        <h4 class="font-semibold">How it works</h4>
        <ol
          class="mt-2 text-sm text-gray-700 list-decimal list-inside space-y-1"
        >
          <li>Browse livestock listings.</li>
          <li>
            Click "Reserve/Book this animal" to send a reservation/booking
            message to the seller through direct call.
          </li>
          <li>Agree payment and pickup directly with the seller offline.</li>
          <li>Mark as sold in your admin panel (admin only).</li>
        </ol>
      </section>
      <section
        id="how"
        class="mt-6 glass-card rounded-2xl p-4 shadow-md border border-white/40"
      >
        <h4 class="font-semibold">Contact & Safety</h4>
        <ol
          class="mt-2 text-sm text-gray-700 list-decimal list-inside space-y-1"
        >
          <li>
            Always confirm the animal and payment details with the seller. Meet
            in a safe public place or use a trusted escrow when possible.
          </li>
        </ol>
      </section>
      <section
        id="how"
        class="mt-6 glass-card rounded-2xl p-4 shadow-md border border-white/40"
      >
        <h4 class="font-semibold">Find vet services</h4>
        <ol
          class="mt-2 text-sm text-gray-700 list-decimal list-inside space-y-1"
        >
          <li>vet name+contacts</li>
        </ol>
      </section>
      <section
        id="how"
        class="mt-6 glass-card rounded-2xl p-4 shadow-md border border-white/40"
      >
        <h4 class="font-semibold">Help hotlines</h4>
        <ol
          class="mt-2 text-sm text-gray-700 list-decimal list-inside space-y-1"
        >
          <li>
            Contact <strong>0716808125-Kidemba</strong> , to get more
            information on livestock locations, livestock owners, movement
            logistics e.t.c
          </li>
          <li>
            Contact <strong>0713943315</strong> , admin to manage livestock
            uploads,mark sold livestock,inquiry
          </li>
        </ol>
      </section>

      <footer class="mt-6 text-center text-xs text-gray-600 pb-8">
        © <span id="year"></span> Mifugo Online Market Place — Tharaka Nithi
        county farmers marketplace
      </footer>
    </div>

    <script>
      const SAMPLE = [
        {
          id: 1,
          title: "Healthy Boran Cow (Adult)",
          price: 65000,
          location: "Kitui",
          type: "Cow",
          sellerName: "John Mwangi",
          sellerPhone: "+254712345678",
          image: "",
          description: "Healthy Boran cow, 4 years old, vaccinated.",
          sold: false,
        },
        {
          id: 2,
          title: "Boer Goat - Male",
          price: 12000,
          location: "Embu",
          type: "Goat",
          sellerName: "Amina Yusuf",
          sellerPhone: "+254700111222",
          image: "",
          description: "Young boer goat perfect for breeding.",
          sold: false,
        },
        {
          id: 3,
          title: "Free-range Chickens (10)",
          price: 4500,
          location: "Nakuru",
          type: "Poultry",
          sellerName: "Peter Otieno",
          sellerPhone: "+254733999888",
          image: "",
          description: "Ten healthy free-range chickens. Great layers.",
          sold: false,
        },
      ];

      const LS_KEY = "mifugo_listings";

      function loadListings() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          if (!raw) {
            localStorage.setItem(LS_KEY, JSON.stringify(SAMPLE));
            return SAMPLE.slice();
          }
          return JSON.parse(raw);
        } catch (e) {
          console.error("Error reading listings", e);
          localStorage.setItem(LS_KEY, JSON.stringify(SAMPLE));
          return SAMPLE.slice();
        }
      }

      function saveListings(list) {
        localStorage.setItem(LS_KEY, JSON.stringify(list));
      }

      let listings = loadListings();

      const listContainer = document.getElementById("list-container");
      const noResults = document.getElementById("no-results");

      function formatPrice(n) {
        return n.toLocaleString();
      }

      // ✅ Replaced WhatsApp function with Direct Call function
      function callHref(phone) {
        const p = phone.replace(/\D/g, "");
        return `tel:${p}`;
      }

      function renderListings(filter = "") {
        listContainer.innerHTML = "";
        const q = filter.trim().toLowerCase();
        const filtered = listings.filter((l) => {
          if (q === "") return true;
          return (
            l.title.toLowerCase().includes(q) ||
            l.type.toLowerCase().includes(q) ||
            l.location.toLowerCase().includes(q)
          );
        });

        if (filtered.length === 0) {
          noResults.classList.remove("hidden");
          return;
        } else {
          noResults.classList.add("hidden");
        }

        filtered.forEach((l) => {
          const card = document.createElement("article");
          card.className =
            "bg-white rounded-xl shadow-sm p-3 border flex gap-3";

          const img = document.createElement("img");
          img.className = "w-28 h-20 object-cover rounded-lg";
          img.alt = l.title;
          img.src =
            l.image ||
            `https://via.placeholder.com/600x400?text=${encodeURIComponent(
              l.type
            )}`;

          const body = document.createElement("div");
          body.className = "flex-1 flex flex-col";

          body.innerHTML = `
        <div class="flex items-start justify-between">
          <div>
            <h4 class="font-bold text-sm">${escapeHtml(l.title)}</h4>
            <p class="text-xs text-gray-600">${escapeHtml(
              l.location
            )} • ${escapeHtml(l.type)}</p>
          </div>
          <div class="text-right">
            <div class="text-sm font-extrabold">Ksh ${formatPrice(
              l.price
            )}</div>
            <div class="text-xs text-gray-500">Seller: ${escapeHtml(
              l.sellerName
            )}</div>
          </div>
        </div>
        <p class="text-xs text-gray-700 mt-2 line-clamp-2">${escapeHtml(
          l.description
        )}</p>
      `;

          const actions = document.createElement("div");
          actions.className = "mt-3 flex gap-2";

          // ✅ Reserve Button now makes a direct phone call
          const reserveBtn = document.createElement("button");
          reserveBtn.className =
            "flex-1 py-2 rounded-lg bg-amber-600 text-white font-semibold text-sm";
          reserveBtn.textContent = l.sold ? "Sold" : "Reserve/book this animal";
          reserveBtn.disabled = !!l.sold;
          reserveBtn.onclick = () => {
            window.location.href = callHref(l.sellerPhone);
          };

          // ✅ Direct Call Button instead of WhatsApp
          const callA = document.createElement("a");
          callA.className =
            "inline-flex items-center px-3 py-2 rounded-lg border border-blue-700 bg-white shadow-sm";
          callA.href = callHref(l.sellerPhone);
          callA.rel = "noreferrer";

          callA.innerHTML = `
        <span class="rounded-full bg-blue-700 p-1 mr-2 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="white" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 5a2 2 0 012-2h3.28a1 1 0 01.95.684l1.518 4.553a1 1 0 01-.342 1.084l-2.12 1.59a11.042 11.042 0 005.516 5.516l1.59-2.12a1 1 0 011.084-.342l4.553 1.518a1 1 0 01.684.95V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
        </span>
        <span class="text-sm font-semibold text-blue-700 uppercase">Call</span>
      `;

          actions.appendChild(reserveBtn);
          actions.appendChild(callA);

          body.appendChild(actions);

          card.appendChild(img);
          card.appendChild(body);

          listContainer.appendChild(card);
        });
      }

      function escapeHtml(unsafe) {
        if (!unsafe && unsafe !== 0) return "";
        return String(unsafe).replace(/[&<>"'`]/g, function (s) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
            "`": "&#96;",
          }[s];
        });
      }

      document
        .getElementById("search")
        .addEventListener("input", (e) => renderListings(e.target.value));

      document.getElementById("year").textContent = new Date().getFullYear();

      renderListings();
    </script>
  </body>
</html>
